<!DOCTYPE HTML>
 
<HTML>
 
<head>
 
<meta charset="UTF-8">
 
<title>Geopost</title>
 
<meta name="viewport" content="width=device-width, initial-scale=1">
 
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
 
 
 <style>
 span.hash{ color : blue };
 
 </style>
 <script>
 
 
 CURRENT_POSITION = null;
 //thanks: http://stackoverflow.com/questions/8188645/javascript-regex-to-match-a-url-in-a-field-of-text
 URL_REGEX = "(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|]";


function setLocation(position){
	CURRENT_POSITION = position;
	latitude = position.coords.latitude;
	longitude = position.coords.longitude;

	$("#latitudeInput").val(""+latitude);
	$("#longitudeInput").val(""+longitude);
}
 
 
 function getLocation() {
	 if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(setLocation);
	 } else {
		alert("gelocation not supported");
	}
}



function makeSet(array){
	set = {}
	for (var i = 0; i < array.length; i++){
		set[array[i]] = true;
	}
	return set;
}

 
 function loadPostsIntoList() {
	///alert("yo");
	$.mobile.showPageLoadingMsg();
	
	if (CURRENT_POSITION == null) {
		setTimeout(loadPostsIntoList,  200);
	} else {
	
		var filterStr = $('input[data-type="search"]').val();
		
		$.get("/posts", 
			{
				"longitude" :  CURRENT_POSITION.coords.longitude,
				"latitude" : CURRENT_POSITION.coords.latitude, 				
				"radius": 1
			},
			function(data) {
				posts = JSON.parse(data);
				$("#postlist").html("");
				for (var i = 0; i < posts.length; i++) {
					message = posts[i].message;
					
					var urls = message.match(new RegExp(URL_REGEX, "ig"));
					
					if (urls != null){
						urls = makeSet(urls);
						for (var url in urls) {
							message = message.replace(url, "<a href='"+url+"'>"+url+"</a>");
						}
					}
					
					var hashes = message.match(new RegExp("#[a-z0-9]+", "gi"))
					if (hashes != null) {
						for (var j = 0; j < hashes.length; j++) {
							message = message.replace(hashes[j], "<span class='hash'>"+hashes[j]+"</span>");
						}
					}					
					$("#postlist").append("<li><h3>"+message+"</h3></li>");
				}
				$("span.hash").click(hashClickHandler);
				$("#postlist").listview().listview("refresh");
				filterBarSearchBy(filterStr);
			}
		).always( function() { 
			$.mobile.hidePageLoadingMsg();
		});
	}
 }
 
 
 function filterBarSearchBy(searchStr){
	//this is a hack to insure there is an update
	$('input[data-type="search"]').val("04-19-1992");
	$('input[data-type="search"]').trigger("keyup");
	$('input[data-type="search"]').val(searchStr);
	$('input[data-type="search"]').trigger("keyup");
 }
 
function hashClickHandler(e) {
	searchStr = $(e.target).html();
	filterBarSearchBy(searchStr);
}

function initList() {
	getLocation();
	loadPostsIntoList();	
}

 $(document).ready(function(){
	initList();
	
	$("#refresh").click(function() {
		initList();
	});
	
	$("#submitpost").click(function () {
		if ( $("#message").val() == "") {
			alert("Message must contain something!");
                } else {
		
			//yeah..this needs to be improved and will probably break if more than one select tags are used
			var time_limit = $($("select")[0]).find(":selected").val();
			$.mobile.showPageLoadingMsg();
			$.post(
				"/posts", 
				{	 
					"message" : $("#message").val(),  
					"longitude" :  CURRENT_POSITION.coords.longitude,
					"latitude" : CURRENT_POSITION.coords.latitude,
					"radius" : 1,
					"time_limit" : time_limit
				}, 
				function(data) {
					$('.ui-dialog').dialog('close');
					$("#message").val('');
					loadPostsIntoList();
				}
			).always(function() { $.mobile.hidePageLoadingMsg() });
		}
	});
	
	$("span.hash").click(hashClickHandler);
	
});




 </script>
 
</head>

<body>

<div data-role="page" id="home">

	<div data-role="header" data-position="fixed">
		<div data-role="controlgroup" data-type="horizontal">
			<a href="#addpost" data-rel="dialog" data-role="button" data-icon="add">Add</a>
			<button data-icon="refresh" id="refresh">Refresh</button>
		</div>
	</div>

	
	<br>
	<ul data-role="listview" data-filter="true" id="postlist"></ul>

</div>
<div data-role="page" id="addpost">
	<div data-role="header">
		<h1>Add Post</h1>
	</div>
	

	<div data-role="fieldcontain" class="ui-hide-label">
		<textarea id="message" placeholder="Message"></textarea>
		<label for="time_limit" class="select">Time limit:</label>
		<select id="time_limt34">
			<option value="60">1 minute</option>
			<option value="300">5 minutes</option>
			<option value="900">15 minues</option>
			<option value="1800">30 minutes</option>
			<option value="3600">1 hour</option>
			<option value="10800">3 hours</option>
			<option value="43200">12 hours</option>
			<option value="86400">1 day</option>
			<option value="259200">3 days</option>
			<option value="604800">1 week</option>
		</select>
		<button id="submitpost">Submit</submit>
	</div>
	
	</form>
	
	
</div>

</body>
</html>
